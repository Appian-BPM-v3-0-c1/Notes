# Transactions

A database transaction is a single unit of work that consists of one or more operations.

A classical example of a transaction is a bank transfer from one account to another. A complete transaction must ensure
a balance between the sender and receiver accounts. It means that if the sender account transfers X amount, the receiver
receives X amount, no more or no less.

A PostgreSQL transaction is atomic, consistent, isolated, and durable. These properties are often referred to as ACID:

- Atomicity guarantees that the transaction completes in an all-or-nothing manner.
- Consistency ensures the change to data written to the database must be valid and follow predefined rules.
- Isolation determines how transaction integrity is visible to other transactions.
- Durability makes sure that transactions that have been committed will be stored in the database permanently.

## Setting up a sample table

Let’s create a new table named accounts for the demonstration:

<pre>
DROP TABLE IF EXISTS accounts;

CREATE TABLE accounts (
id INT GENERATED BY DEFAULT AS IDENTITY,
name VARCHAR(100) NOT NULL,
balance DEC(15,2) NOT NULL,
PRIMARY KEY(id)
);
</pre>

## Begin a transaction

When you execute the following `INSERT `statement:

<pre>
INSERT INTO accounts(name,balance)
VALUES('Bob',10000); 
</pre>

PostgreSQL inserted a new row into the accounts' table immediately. In this case, you do not know when the transaction
begins and cannot intercept the modification such as rolling it back.

To start a transaction, you use the following statement:

<pre>
BEGIN TRANSACTION;
</pre>

<br> 

# ACID properties

A transaction is a single logical unit of work which accesses and possibly modifies the contents of a database.
Transactions access data using read and write operations. In order to maintain consistency in a database, before and
after the transaction, certain properties are followed. These are called ACID properties.

<img style="width: 60%;" src="https://media.geeksforgeeks.org/wp-content/cdn-uploads/20191121102921/ACID-Properties.jpg">

## Atomicity

By this, we mean that either the entire transaction takes place at once or doesn’t happen at all. There is no midway
i.e. transactions do not occur partially. Each transaction is considered as one unit and either runs to completion or is
not executed at all. It involves the following two operations.

- Abort: If a transaction aborts, changes made to database are not visible.
- Commit: If a transaction commits, changes made are visible. Atomicity is also known as the ‘All or nothing rule’.

## Consistency

This means that integrity constraints must be maintained so that the database is consistent before and after the
transaction.

## Isolation

This property ensures that multiple transactions can occur concurrently without leading to the inconsistency of database
state. Transactions occur independently without interference. Changes occurring in a particular transaction will not be
visible to any other transaction until that particular change in that transaction is written to memory or has been
committed. This property ensures that the execution of transactions concurrently will result in a state that is
equivalent to a state achieved these were executed serially in some order.

## Durability:

This property ensures that once the transaction has completed execution, the updates and modifications to the database
are stored in and written to disk and they persist even if a system failure occurs. These updates now become permanent
and are stored in non-volatile memory. The effects of the transaction, thus, are never lost.

<br> 

# Transaction Phenomenon

Because isolation levels other than repeatable read allow updates by other applications while an application is reading
data, the application that is reading data might retrieve more or fewer rows than are expected.

The phenomena that can occur are called **phantom rows**, **dirty read**, and **non-repeatable read**.

## Phantom rows

SQL transaction T1 reads a set of rows that satisfy some search condition on a table. SQL transaction T2 then executes
SQL statements that generate one or more new rows in the table that also satisfy the search condition that is used by
SQL transaction T1. If T1 then repeats the original read with the same search condition, T1 receives a different set of
rows.

This phenomenon can occur with uncommitted read (UR), cursor stability (CS), or read stability (RS) isolation.

## Dirty read

SQL transaction T1 modifies a row. SQL transaction T2 reads that row before T1 executes a commit operation. If T1 then
executes a rollback operation, T2 will have read a row that was never committed, and therefore can be considered never
to have existed.

This phenomenon can occur with uncommitted read (UR) isolation.

## Non-repeatable read

SQL transaction T1 reads a row. SQL transaction T2 then modifies or deletes that row and executes a commit operation. If
T1 then attempts to reread that row, T1 might receive the modified value or discover that the row has been deleted.

This phenomenon can occur with uncommitted read (UR) or cursor stability (CS) isolation.

<img style="width: 60%" src="https://res.cloudinary.com/practicaldev/image/fetch/s--F01OueTr--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/i/sdugj4k9rky6iaj5rk1c.png">

<br>

# Sequence

Sequence is a set of integers 1, 2, 3, … that are generated and supported by some database systems to produce unique
values on demand.

- A sequence is a user defined schema bound object that generates a sequence of numeric values.


- Sequences are frequently used in many databases because many applications require each row in a table to contain a
  unique value and sequences provides an easy way to generate them.


- The sequence of numeric values is generated in an ascending or descending order at defined intervals and can be
  configured to restart when exceeds max_value.

### Example 1

Following is the sequence query creating sequence in ascending order.

<pre>
CREATE SEQUENCE sequence_1
start with 1
increment by 1
minvalue 0
maxvalue 100
cycle;
</pre>

## Example 2

Following is the sequence query creating sequence in descending order.

<pre>
CREATE SEQUENCE sequence_2
start with 100
increment by -1
minvalue 1
maxvalue 100
cycle;
</pre>

<br>

# Views

A view is a named query that provides another way to present data in the database tables. A view is defined based on one
or more tables which are known as base tables. When you create a view, you basically create a query and assign a name to
the query. Therefore, a view is useful for wrapping a commonly used complex query.